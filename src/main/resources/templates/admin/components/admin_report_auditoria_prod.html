<div class="admin_auditoria_producto">

    <h3 class="titulo-reporte">
        <i class="fas fa-clipboard-list"></i> Auditoría por Producto
    </h3>

    <!-- FILTROS -->
    <div class="filtros-reporte">

        <div class="campo">
            <label>Producto:</label>
            <select id="idProducto" class="form-select"></select>
        </div>

        <div class="campo">
            <label>Tipo de Bloque:</label>
            <select id="tipo" class="form-select">
                <option value="semana">Semana</option>
                <option value="mes">Mes</option>
                <option value="anio">Año</option>
                <option value="rango">Rango de fechas</option>
            </select>
        </div>

        <div class="campo campo-fecha" style="display:none;">
            <label>Fecha inicio:</label>
            <input type="date" id="fechaInicio" class="form-control">
        </div>

        <div class="campo campo-fecha" style="display:none;">
            <label>Fecha fin:</label>
            <input type="date" id="fechaFin" class="form-control">
        </div>

        <button class="btn-buscar" onclick="generarBloques()">
            <i class="fas fa-search"></i> Generar Bloques
        </button>

    </div>

    <!-- BLOQUES -->
    <div id="listaBloques" class="bloques-grid"></div>

    <!-- DETALLE -->
    <div id="tablaDetalle" class="mt-4"></div>

    <div id="descargas" style="margin-top: 12px; display:none;">
        <button class="btn-buscar" id="btnPDF"><i class="fas fa-file-pdf"></i> Descargar PDF</button>
        <button class="btn-buscar" id="btnExcel"><i class="fas fa-file-excel"></i> Descargar Excel</button>
    </div>

</div>

<style>
    .titulo-reporte {
        font-size: 22px;
        margin-bottom: 18px;
        font-weight: 600;
        color: #333;
    }

    .filtros-reporte {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: flex-end;
        background: #fafafa;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        margin-bottom: 22px;
    }

    .filtros-reporte .campo label {
        font-size: 14px;
        font-weight: 600;
        color: #444;
        display: block;
        margin-bottom: 4px;
    }

    .filtros-reporte input,
    .filtros-reporte select {
        padding: 6px 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 100%;
    }

    .btn-buscar {
        background: #444;
        color: white;
        padding: 8px 14px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
    }

    .btn-buscar:hover {
        background: #222;
    }

    .bloques-grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        margin-top: 15px;
    }

    .bloques-grid .card {
        background: #ffffff;
        border-radius: 14px;
        padding: 18px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        transition: all 0.25s ease;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .bloques-grid .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
    }

    .bloques-grid .titulo-bloque {
        font-size: 15px;
        font-weight: 700;
        color: #1f2937;
    }

    .bloques-grid .rango-fecha {
        font-size: 13px;
        color: #6b7280;
    }

    .btn-detalle {
        font-size: 13px;
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #2563eb;
        background: #2563eb;
        color: white;
        cursor: pointer;
        transition: 0.2s;
        width: fit-content;
    }

    .btn-detalle:hover {
        background: #1d4ed8;
    }

    .tabla-admin {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
    }

    .tabla-admin th,
    .tabla-admin td {
        padding: 8px;
        border: 1px solid #ddd;
        text-align: center;
    }

    .tabla-admin th {
        background: #f0f0f0;
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        cargarProductosAuditoria();
        activarEventosAuditoria();
    });


    fetch("/admin/api/auditoria/producto/lista")
        .then(r => r.json())
        .then(lista => {
            const select = document.getElementById("idProducto");
            lista.forEach(p => {
                select.innerHTML += `<option value="${p.idProdHistoria}">${p.nombre}</option>`;
            });
        });


    function activarEventosAuditoria() {
        const tipoSelect = document.getElementById("tipo");
        const fechaCampos = document.querySelectorAll(".campo-fecha");

        tipoSelect.addEventListener("change", e => {
            const mostrar = e.target.value === "rango";
            fechaCampos.forEach(c => c.style.display = mostrar ? "block" : "none");
        });
    }

    function formatearFecha(fechaStr) {
        if (!fechaStr) return "-";

        // Normalizar distintos formatos
        let fecha;

        // Caso 1: viene como "2025-02-01" o ISO
        if (/^\d{4}-\d{2}-\d{2}/.test(fechaStr)) {
            const [anio, mes, dia] = fechaStr.substring(0, 10).split("-");
            fecha = new Date(`${anio}-${mes}-${dia}T00:00:00`);
        }
        // Caso 2: DD/MM/AAAA
        else if (/^\d{2}\/\d{2}\/\d{4}$/.test(fechaStr)) {
            const [dia, mes, anio] = fechaStr.split("/");
            fecha = new Date(`${anio}-${mes}-${dia}`);
        }
        // Caso 3: AAAA/MM/DD
        else if (/^\d{4}\/\d{2}\/\d{2}$/.test(fechaStr)) {
            const [anio, mes, dia] = fechaStr.split("/");
            fecha = new Date(`${anio}-${mes}-${dia}`);
        }
        else {
            return "-"; // formato desconocido
        }

        if (isNaN(fecha.getTime())) return "-";

        return fecha.toLocaleDateString("es-PE", {
            weekday: "short",
            day: "numeric",
            month: "short",
            year: "numeric"
        });
    }


    function obtenerNumeroSemana(fechaStr) {
        const fecha = new Date(fechaStr);
        const f = new Date(Date.UTC(fecha.getFullYear(), fecha.getMonth(), fecha.getDate()));
        const diaSemana = f.getUTCDay() || 7;
        f.setUTCDate(f.getUTCDate() + 4 - diaSemana);
        const inicioAno = new Date(Date.UTC(f.getUTCFullYear(), 0, 1));
        return Math.ceil((((f - inicioAno) / 86400000) + 1) / 7);
    }

    function generarBloques() {
        const idProducto = document.getElementById("idProducto").value;
        const tipo = document.getElementById("tipo").value;

        if (!idProducto) {
            alert("Debe seleccionar un producto.");
            return;
        }

        let url = `/admin/api/auditoria/producto/bloques?idProducto=${idProducto}&tipo=${tipo}`;

        if (tipo === "rango") {
            const inicio = document.getElementById("fechaInicio").value;
            const fin = document.getElementById("fechaFin").value;

            if (!inicio || !fin) {
                alert("Debe seleccionar ambas fechas para rango.");
                return;
            }
            url += `&inicio=${inicio}&fin=${fin}`;
        }

        fetch(url)
            .then(r => r.json())
            .then(bloques => {
                const cont = document.getElementById("listaBloques");
                cont.innerHTML = "";

                if (!bloques || bloques.length === 0) {
                    cont.innerHTML = `<p class="text-muted">No hay bloques disponibles.</p>`;
                    return;
                }


                const grupos = {};

                if (tipo === "semana") {
                    // Año → Mes → Semanas
                    bloques.forEach(b => {
                        const anio = b.inicio.substring(0, 4);
                        const mes = new Date(b.inicio).toLocaleString("es-PE", { month: "long" });

                        if (!grupos[anio]) grupos[anio] = {};
                        if (!grupos[anio][mes]) grupos[anio][mes] = [];

                        grupos[anio][mes].push(b);
                    });

                } else if (tipo === "mes") {
                    // Año → Mes (sin semanas)
                    bloques.forEach(b => {
                        const anio = b.inicio.substring(0, 4);
                        const [anioNum, mesNum] = b.inicio.split("-");
                        const mes = new Date(`${anioNum}-${mesNum}-01T00:00:00`).toLocaleString("es-PE", { month: "long" });

                        if (!grupos[anio]) grupos[anio] = {};
                        if (!grupos[anio][mes]) grupos[anio][mes] = [];

                        grupos[anio][mes].push(b);
                    });

                } else {
                    // Año y Rango → sin agrupación
                    grupos["Listado"] = { "Sin grupo": bloques };
                }

                // --- CONSTRUCCIÓN VISUAL DE BLOQUES ---
                Object.keys(grupos).forEach(anio => {
                    // encabezado año
                    if (anio !== "Listado") {
                        cont.innerHTML += `
                        <h3 style="grid-column:1/-1; margin-top:25px; color:#111; font-weight:700;">
                            ${anio}
                        </h3>
                    `;
                    }

                    Object.keys(grupos[anio]).forEach(mes => {

                        if (mes !== "Sin grupo" && tipo === "semana") {
                            cont.innerHTML += `
                            <h4 style="grid-column:1/-1; margin-top:10px; margin-left:10px; color:#333; font-weight:600;">
                                ${mes.charAt(0).toUpperCase() + mes.slice(1)}
                            </h4>
                        `;
                        }

                        grupos[anio][mes].forEach(b => {
                            const fInicio = formatearFecha(b.inicio.substring(0, 10));
                            const fFin = formatearFecha(b.fin.substring(0, 10));

                            const anioBloque = b.inicio.substring(0, 4);
                            const mesNumero = String(new Date(b.inicio).getMonth() + 1).padStart(2, "0");

                            let tituloMostrar = "";

                            if (tipo === "semana") {
                                const numSemana = obtenerNumeroSemana(b.inicio);
                                tituloMostrar = `${anioBloque}-${mesNumero}-Semana${numSemana}`;
                            }
                            else if (tipo === "mes") {
                                const [anioNum, mesNum] = b.inicio.split("-");
                                const fechaMes = new Date(`${anioNum}-${mesNum}-01T00:00:00`);
                                const nombreMes = fechaMes.toLocaleString("es-PE", { month: "long" });
                                const mesCapitalizado = nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1);

                                tituloMostrar = `${mesCapitalizado} ${anioNum}`;
                            }

                            else if (tipo === "anio") {
                                tituloMostrar = `${anio}`;
                            }
                            else {
                                tituloMostrar = `${fInicio} - ${fFin}`;
                            }

                            cont.innerHTML += `
                                <div class="card">
                                    <div class="titulo-bloque">${tituloMostrar}</div>
                                    <div class="rango-fecha">${fInicio} - ${fFin}</div>
<button class="btn-detalle" 
        onclick="verDetalle(${idProducto}, '${b.inicio.substring(0, 10)}', '${b.fin.substring(0, 10)}')">
    Ver detalle
</button>
                                </div>
                            `;
                        });
                    });
                });



            })
            .catch(err => console.error("Error generando bloques:", err));
    }

    function verDetalle(idProducto, inicio, fin) {
        const selectProducto = document.getElementById("idProducto");
        const nombreProducto = selectProducto.options[selectProducto.selectedIndex].text;
        const fechaExport = new Date().toLocaleString();
        const tipo = document.getElementById("tipo").value;

        fetch(`/admin/api/auditoria/producto/detalle?idProducto=${idProducto}&inicio=${inicio}&fin=${fin}`)
            .then(r => r.json())
            .then(filas => {
                const tabla = document.getElementById("tablaDetalle");
                if (!filas || filas.length === 0) {
                    tabla.innerHTML = "<p class='text-muted'>No hay registros en este bloque.</p>";
                    document.getElementById("descargas").style.display = "none";
                    return;
                }

                let bloqueTexto = "";
                if (tipo === "semana") bloqueTexto = `${formatearFecha(inicio)} - ${formatearFecha(fin)}`;
                else if (tipo === "mes") bloqueTexto = `${inicio.substring(0, 7)}`; // AAAA-MM
                else if (tipo === "anio") bloqueTexto = inicio.substring(0, 4);
                else bloqueTexto = `${formatearFecha(inicio)} - ${formatearFecha(fin)}`;

                let html = `
                <h5>Detalle del bloque</h5>
                <p><strong>Producto:</strong> ${nombreProducto}</p>
                <p><strong>Bloque:</strong> ${bloqueTexto}</p>
                <p><strong>Fecha de exportación:</strong> ${fechaExport}</p>
                <table class="tabla-admin">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Cantidad Vendida</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filas.map(f => `
                            <tr>
                                <td>${formatearFecha(f.fecha)}</td>
                                <td>${f.cantidad ?? f.Cantidad ?? "-"}</td>
                                <td>${f.subtotal ?? f.Subtotal ?? "-"}</td>
                            </tr>`).join("")}
                    </tbody>
                </table>`;
                tabla.innerHTML = html;

                // Guardar info en dataset para exportaciones
                tabla.dataset.producto = nombreProducto;
                tabla.dataset.bloque = bloqueTexto;
                tabla.dataset.fechaExport = fechaExport;

                document.getElementById("descargas").style.display = "block";
            })
            .catch(err => console.error("Error cargando detalle:", err));
    }




</script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    // Exportar Excel
    document.getElementById("btnExcel").addEventListener("click", () => {
        const tabla = document.querySelector(".tabla-admin");
        if (!tabla) { alert("No hay datos para exportar"); return; }

        const wb = XLSX.utils.book_new();

        // Extraer datos del contenedor
        const contenedor = document.getElementById("tablaDetalle");
        const producto = contenedor.dataset.producto || "-";
        const bloque = contenedor.dataset.bloque || "-";
        const fechaExport = contenedor.dataset.fechaExport || "-";

        // Crear hoja manualmente para incluir Producto, Bloque y Fecha de exportación
        const hojaDatos = [];
        hojaDatos.push([`Reporte de Auditoría por Producto`]);
        hojaDatos.push([`Producto: ${producto}`]);
        hojaDatos.push([`Bloque: ${bloque}`]);
        hojaDatos.push([`Fecha de exportación: ${fechaExport}`]);
        hojaDatos.push([]); // fila vacía

        // Agregar encabezados de tabla
        const headers = Array.from(tabla.querySelectorAll("thead th")).map(th => th.innerText);
        hojaDatos.push(headers);

        // Agregar filas
        const dataRows = Array.from(tabla.querySelectorAll("tbody tr")).map(tr =>
            Array.from(tr.querySelectorAll("td")).map(td => td.innerText)
        );
        hojaDatos.push(...dataRows);

        const ws = XLSX.utils.aoa_to_sheet(hojaDatos);
        XLSX.utils.book_append_sheet(wb, ws, "Auditoria");
        XLSX.writeFile(wb, `auditoria_${producto.replace(/\s/g, "_")}.xlsx`);
    });

    // Exportar PDF
    document.getElementById("btnPDF").addEventListener("click", () => {
        const tabla = document.querySelector(".tabla-admin");
        if (!tabla) { alert("No hay datos para exportar"); return; }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Extraer datos del contenedor
        const contenedor = document.getElementById("tablaDetalle");
        const producto = contenedor.dataset.producto || "-";
        const bloque = contenedor.dataset.bloque || "-";
        const fechaExport = contenedor.dataset.fechaExport || "-";

        // Títulos y metadatos
        doc.setFontSize(12);
        doc.text(`Reporte de Auditoría por Producto`, 14, 15);
        doc.text(`Producto: ${producto}`, 14, 22);
        doc.text(`Bloque: ${bloque}`, 14, 29);
        doc.text(`Fecha de exportación: ${fechaExport}`, 14, 36);

        // Extraer datos de la tabla
        const headers = Array.from(tabla.querySelectorAll("thead th")).map(th => th.innerText);
        const data = Array.from(tabla.querySelectorAll("tbody tr")).map(tr =>
            Array.from(tr.querySelectorAll("td")).map(td => td.innerText)
        );

        doc.autoTable({
            startY: 42,
            head: [headers],
            body: data,
        });

        doc.save(`auditoria_${producto.replace(/\s/g, "_")}.pdf`);
    });

</script>