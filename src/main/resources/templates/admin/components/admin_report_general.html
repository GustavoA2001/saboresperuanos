<div class="reporte-wrapper">

    <!-- ENCABEZADO -->
    <h2 class="reporte-titulo">游늵 Reporte General del Sistema</h2>
    <p class="reporte-desc">Selecciona los filtros para generar un reporte completo del sistema.</p>

    <!-- FILTROS -->
    <div class="reporte-filtros">

        <!-- Tipo de reporte -->
        <div class="filtro-box">
            <label>Tipo de reporte:</label>
            <select id="tipoReporte" class="filtro-select">
                <option value="ventas">Ventas Totales</option>
                <option value="productos">Movimientos por Producto</option>
                <option value="categorias">Categorias m치s vendidas</option>
                <option value="clientes">Clientes frecuentes</option>
                <option value="ingresos">Ingresos del d칤a</option>
            </select>
        </div>

        <!-- Rango de tiempo -->
        <div class="filtro-box">
            <label>Rango:</label>
            <select id="rangoFecha" class="filtro-select" onchange="cambiarFiltroFecha()">
                <option value="dia">Hoy</option>
                <option value="semana">Esta semana</option>
                <option value="mes">Este mes</option>
                <option value="anio">Este a침o</option>
                <option value="custom">Personalizado</option>
            </select>
        </div>

        <!-- Fechas personalizadas -->
        <div id="fechasPersonalizadas" class="filtro-custom" style="display:none;">
            <label>Desde:</label>
            <input type="date" id="fechaIni">
            <label>Hasta:</label>
            <input type="date" id="fechaFin">
        </div>

        <button class="btn-generar" onclick="generarReporte()">Generar Reporte</button>

    </div>

    <hr class="divisor">

    <!-- RESULTADO -->
    <div id="resultadoReporte">

        <!-- TARJETAS RESUMEN -->
        <div class="resumen-grid">
            <div class="card-resumen">
                <h3>S/. 0.00</h3>
                <p>Total Ventas</p>
            </div>

            <div class="card-resumen">
                <h3>0</h3>
                <p>Productos Vendidos</p>
            </div>

            <div class="card-resumen">
                <h3>0</h3>
                <p>Clientes Atendidos</p>
            </div>

            <div class="card-resumen">
                <h3>0</h3>
                <p>Comprobantes Emitidos</p>
            </div>
        </div>

        <!-- GR츼FICA -->
        <div class="grafico-box">
            <h3>Evoluci칩n del per칤odo</h3>

            <!-- Lienzo para la gr치fica -->
            <canvas id="graficoGeneral" width="400" height="150"></canvas>
        </div>

    </div>

    <!-- TABLA RESUMEN -->
    <div class="tabla-box">
        <h3>Detalle del reporte</h3>

        <table class="tabla-reporte">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Detalle</th>
                    <th>Movimientos</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody id="tablaResultados">
                <tr>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- EXPORTAR -->
    <button class="btn-export pdf" onclick="exportarPDF()">游늯 Exportar PDF</button>
    <button class="btn-export excel" onclick="exportarExcel()">游늵 Exportar Excel</button>
</div>


<!-- ESTILOS -->
<style>
    .reporte-wrapper {
        padding: 25px;
        animation: fadeIn .3s ease-in-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .reporte-titulo {
        font-size: 28px;
        font-weight: 800;
        margin-bottom: 5px;
        color: #2d2f35;
    }

    .reporte-desc {
        font-size: 15px;
        margin-bottom: 25px;
        color: #555;
    }

    .reporte-filtros {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin-bottom: 25px;
        background: #fff;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    }

    .filtro-box label {
        font-weight: bold;
        color: #333;
        font-size: 14px;
    }

    .filtro-select,
    input[type="date"] {
        padding: 10px;
        border-radius: 7px;
        border: 1px solid #ccc;
        margin-top: 5px;
        width: 220px;
        transition: .2s;
    }

    .filtro-select:hover,
    input[type="date"]:hover {
        border-color: #2d89ff;
    }

    .filtro-custom {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .btn-generar {
        background: #1e63d5;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        font-size: 15px;
        align-self: end;
        transition: .2s;
    }

    .btn-generar:hover {
        background: #154fab;
    }

    .resumen-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .card-resumen {
        background: linear-gradient(#ffffff, #f4f6f8);
        padding: 20px;
        border-radius: 14px;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
        text-align: center;
        transition: .2s;
    }

    .card-resumen:hover {
        transform: translateY(-3px);
    }

    .card-resumen h3 {
        margin: 0;
        font-size: 26px;
        font-weight: bold;
        color: #1e1f24;
    }

    .card-resumen p {
        color: #777;
        font-size: 14px;
    }

    .grafico-box {
        background: white;
        padding: 25px;
        border-radius: 14px;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }

    .tabla-box {
        background: white;
        padding: 25px;
        border-radius: 14px;
        margin-top: 20px;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
    }

    .tabla-reporte {
        width: 100%;
        border-collapse: collapse;
    }

    .tabla-reporte th {
        background: #f1f3f6;
        padding: 12px;
        text-align: left;
        font-weight: bold;
    }

    .tabla-reporte td {
        padding: 12px;
        border-bottom: 1px solid #eee;
    }

    .export-buttons {
        margin-top: 30px;
        display: flex;
        gap: 15px;
    }

    .btn-export {
        padding: 12px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        transition: .2s;
    }

    .btn-export.pdf {
        background: #c0392b;
        color: white;
    }

    .btn-export.pdf:hover {
        background: #962d23;
    }

    .btn-export.excel {
        background: #2ecc71;
        color: white;
    }

    .btn-export.excel:hover {
        background: #25a95a;
    }

    #graficoGeneral {
        width: 100% !important;
        height: 260px !important;
    }
</style>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function cambiarFiltroFecha() {
    const rango = document.getElementById("rangoFecha").value;
    document.getElementById("fechasPersonalizadas").style.display =
        rango === "custom" ? "flex" : "none";
    actualizarRangoTexto();
}
// Actualizar texto legible del rango
function actualizarRangoTexto(inicio, fin) {
    const p = document.getElementById("rangoSeleccionado");
    if (inicio && fin) {
        p.innerText = `Desde ${formatearFechaLegible(inicio)} hasta ${formatearFechaLegible(fin)}`;
    } else {
        p.innerText = "-";
    }
}
    // -----------------------------
    // Variables globales para exportar
    // -----------------------------
    let fechaInicioGlobal = null;
    let fechaFinGlobal = null;
    let grafico;

    // -----------------------------
    // Cambiar visibilidad de fechas personalizadas
    // -----------------------------
    function cambiarFiltroFecha() {
        const rango = document.getElementById("rangoFecha").value;
        document.getElementById("fechasPersonalizadas").style.display =
            rango === "custom" ? "flex" : "none";
    }

    // -----------------------------
    // Generar reporte
    // -----------------------------
    function generarReporte() {
        const tipo = document.getElementById("tipoReporte").value;
        const rango = document.getElementById("rangoFecha").value;

        let inicio, fin;
        const hoy = new Date();
        const copia = new Date();

        switch (rango) {
            case "dia":
                inicio = formatearFecha(hoy);
                fin = formatearFecha(hoy);
                break;
            case "semana":
                copia.setDate(hoy.getDate() - 7);
                inicio = formatearFecha(copia);
                fin = formatearFecha(hoy);
                break;
            case "mes":
                copia.setMonth(hoy.getMonth() - 1);
                inicio = formatearFecha(copia);
                fin = formatearFecha(hoy);
                break;
            case "anio":
                copia.setFullYear(hoy.getFullYear() - 1);
                inicio = formatearFecha(copia);
                fin = formatearFecha(hoy);
                break;
            case "custom":
                inicio = document.getElementById("fechaIni").value;
                fin = document.getElementById("fechaFin").value;
                break;
        }

        if (!inicio || !fin) {
            alert("Seleccione un rango de fechas v치lido.");
            return;
        }

        // Guardar fechas para exportar
        fechaInicioGlobal = inicio;
        fechaFinGlobal = fin;

        // Llamada al backend
        fetch(`/admin/api/reporte/general?inicio=${inicio}&fin=${fin}`)
            .then(res => res.json())
            .then(data => actualizarVista(data))
            .catch(err => console.error(err));
    }

    // -----------------------------
    // Formatear fecha a yyyy-MM-dd
    // -----------------------------
    function formatearFecha(date) {
        const m = (date.getMonth() + 1).toString().padStart(2, "0");
        const d = date.getDate().toString().padStart(2, "0");
        return `${date.getFullYear()}-${m}-${d}`;
    }

    // -----------------------------
    // Actualizar tarjetas, tabla y gr치fico
    // -----------------------------
    function actualizarVista(data) {
        // Tarjetas
        const cards = document.querySelectorAll(".card-resumen h3");
        cards[0].innerText = `S/. ${data.ventasTotales ?? 0}`;
        cards[1].innerText = data.productosVendidos ?? 0;
        cards[2].innerText = data.clientesFrecuentes?.length ?? 0;
        cards[3].innerText = data.detalle?.length ?? 0;

        // Tabla
        const tbody = document.getElementById("tablaResultados");
        tbody.innerHTML = "";
        data.detalle?.forEach(row => {
            tbody.innerHTML += `
                <tr>
                    <td>${row.FechaPedido}</td>
                    <td>${row.detalle}</td>
                    <td>${row.movimientos}</td>
                    <td>S/. ${row.total}</td>
                </tr>
            `;
        });

        // Gr치fico
        const ctx = document.getElementById("graficoGeneral").getContext("2d");
        if (grafico) grafico.destroy();
        grafico = new Chart(ctx, {
            type: "line",
            data: {
                labels: data.evolucion?.map(e => e.fecha) ?? [],
                datasets: [{
                    label: "Ventas",
                    data: data.evolucion?.map(e => e.total) ?? [],
                    borderWidth: 2,
                    tension: .3
                }]
            }
        });
    }

    // -----------------------------
    // Exportar PDF
    // -----------------------------
    function exportarPDF() {
        if (!fechaInicioGlobal || !fechaFinGlobal) {
            alert("Primero genera un reporte antes de exportar.");
            return;
        }
        window.location.href =
            `/admin/reporte/general/pdf?inicio=${fechaInicioGlobal}&fin=${fechaFinGlobal}`;
    }

    // -----------------------------
    // Exportar Excel
    // -----------------------------
    function exportarExcel() {
        if (!fechaInicioGlobal || !fechaFinGlobal) {
            alert("Primero genera un reporte antes de exportar.");
            return;
        }
        window.location.href =
            `/admin/reporte/general/excel?inicio=${fechaInicioGlobal}&fin=${fechaFinGlobal}`;
    }
</script>