<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADM | Carta</title>

    <link th:include="components/link">
    <link rel="stylesheet" th:href="@{/css/menu.css}">
    <script src="https://kit.fontawesome.com/35db202371.js" crossorigin="anonymous"></script>

    <style>
        body {
            background-color: var(--base-color);
            color: var(--text-color);
            font-family: 'Cabin', sans-serif;
        }

        main.adm-main {
            flex-grow: 1;
            padding: 40px;
        }

        h1.adm-page-title {
            font-weight: 700;
            font-size: 1.8rem;
            margin-bottom: 30px;
            text-align: left;
            color: var(--color-fifth);
        }

        .tables-flex {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        /* ===== NUEVO NOMBRE PARA adm-card ===== */

        .panel-box {
            flex: 1;
            min-width: 350px;
            background: var(--color-light);
            border-radius: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
            padding: 0 !important;
        }

        .panel-header {
            padding: 14px 20px;
            color: #fff;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-body {
            padding: 15px 20px 25px;
        }

        .panel-footer {
            padding: 15px 20px;
            text-align: right;
            border-top: 1px solid #ddd;
            background: var(--color-light);
        }

        /* ======================================= */

        .bg-primary {
            background-color: var(--color-fifth);
        }

        .bg-success {
            background-color: var(--color-fourth);
        }

        .adm-btn-close {
            background: var(--color-fifth);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }

        .adm-btn-close:hover {
            background: var(--color-fourth);
        }

        table.adm-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .adm-table thead {
            background-color: var(--color-third);
            color: var(--color-light);
        }

        .adm-table th,
        .adm-table td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--color-primary);
            text-align: center;
        }

        .adm-table tbody tr:hover {
            background: var(--base-variant);
            color: #2b2828;
            transition: 0.3s;
        }

        .adm-actions {
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .adm-btn-text {
            text-decoration: none;
            border: 1px solid var(--color-fifth);
            background: transparent;
            color: var(--color-fifth);
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: 0.25s;
        }

        /* Bot√≥n eliminar en rojo */
        .adm-btn-text.eliminar {
            border-color: #d9534f;
            color: #d9534f;
        }

        .adm-btn-text.eliminar:hover {
            background: #d9534f;
            color: white;
        }


        .adm-actions button:hover,
        .adm-actions a:hover {
            background: var(--color-fourth);
            color: white;
        }

        /* Anchos de columnas */
        .adm-table colgroup col:nth-child(1) {
            width: 5%;
        }

        .adm-table colgroup col:nth-child(2) {
            width: 16%;
        }

        .adm-table colgroup col:nth-child(3) {
            width: 8%;
        }

        .adm-table colgroup col:nth-child(4) {
            width: 8%;
        }

        .adm-table colgroup col:nth-child(5) {
            width: 10%;
        }

        .adm-table colgroup col:nth-child(6) {
            width: 8%;
        }

        .adm-table colgroup col:nth-child(7) {
            width: 10%;
        }

        .adm-table colgroup col:nth-child(8) {
            width: 10%;
        }

        .adm-table colgroup col:nth-child(9) {
            width: 25%;
        }

        @media (max-width: 900px) {
            .tables-flex {
                flex-direction: column;
            }
        }

        .modal-carta {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-carta.active {
            display: flex;
        }

        .modal-contenido {
            width: 92%;
            max-width: 650px;
            background: #fff;
            padding: 22px;
            border-radius: 14px;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.2);
            animation: fadeIn .25s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            border: none;
            background: transparent;
            font-size: 22px;
            cursor: pointer;
        }

        .subtitle {
            font-size: 14px;
            color: #666;
            margin: 5px 0 15px;
        }

        /* LISTA */
        .lista-productos-modal {
            max-height: 680px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .item-modal {
            display: flex;
            justify-content: space-between;
            border: 1px solid #e3e3e3;
            padding: 0px 14px;
            border-radius: 10px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: 0.2s;
        }

        .item-modal:hover {
            background: #eccec04f;
        }

        .item-modal.selected {
            background: #d0b5a84f;
            border-color: var(--primary-color);
        }

        .item-modal h4 {
            margin-bottom: 4px;
        }

        .tag {
            font-weight: 600;
            margin-right: 4px;
        }

        .select-icon {
            display: none;
            font-size: 20px;
            color: var(--second-color);
            align-self: center;
        }

        .item-modal.selected .select-icon {
            display: block;
        }

        /* Footer */
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
        }

        .btn-agregar-final {
            background: var(--color-third);
            color: #fff;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: 0.2s;
        }

        .input-tabla {
            width: 80px;
            padding: 6px 4px 3px;
            border: 1px solid #aaa;
            border-radius: 6px;
            text-align: center;
            font-size: 20px;
        }

        .btn-agregar-final:hover {
            background: var(--color-fourth);
        }

        @keyframes fadeIn {
            from {
                transform: scale(.92);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <header th:include="/admin/adminMenu"></header>

    <main class="adm-main">
        <h1 class="adm-page-title">Gesti√≥n de la Carta</h1>

        <div class="tables-flex">

            <div class="panel-box">
                <div class="panel-header bg-primary">
                    <div>Productos de la Carta</div>
                </div>

                <div class="panel-body">

                    <div class="adm-table-container">
                        <table class="adm-table">
                            <colgroup>
                                <col>
                                <col>
                                <col>
                                <col>
                                <col>
                                <col>
                                <col>
                                <col>
                                <col>
                            </colgroup>

                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Precio</th>
                                    <th>Cant. Inicial</th>
                                    <th>Vendidos</th>
                                    <th>Stock</th>
                                    <th>Visible</th>
                                    <th>Estado D√≠a</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>

                            <tbody>
                                <tr th:each="prod : ${productosRecientes}">
                                    <td th:text="${prod['idProducto']}"></td>
                                    <td th:text="${prod['nomProducto']}"></td>
                                    <td>
                                        <input type="number" step="0.10" min="0" th:value="${prod['precioUnitario']}"
                                            class="input-tabla league-spartan"
                                            th:id="'precio_' + ${prod['idProducto']}">
                                    </td>

                                    <td>
                                        <input type="number" min="0" th:value="${prod['cantidadInicial']}"
                                            class="input-tabla league-spartan"
                                            th:id="'cantidad_' + ${prod['idProducto']}">
                                    </td>

                                    <td th:text="${prod['vendidos']}"></td>
                                    <td th:text="${prod['stock']}"></td>
                                    <td th:text="${prod['visible'] ? 'S√≠' : 'No'}"></td>
                                    <td th:text="${prod['estadoDia']}"></td>

                                    <td class="adm-actions">

                                        <button class="adm-btn-text league-spartan"
                                            th:onclick="guardarProducto([[${prod['idProducto']}]]);">
                                            Guardar
                                        </button>


                                        <button th:if="${prod['visible']}"
                                            th:onclick="'cambiarVisible(' + ${prod['idProducto']} + ', false)'"
                                            class="adm-btn-text league-spartan">
                                            Ocultar
                                        </button>

                                        <button th:if="${!prod['visible']}"
                                            th:onclick="'cambiarVisible(' + ${prod['idProducto']} + ', true)'"
                                            class="adm-btn-text league-spartan">
                                            Mostrar
                                        </button>

                                        <button th:if="${prod['estadoDia'] != 'agotado'}"
                                            th:onclick="'cambiarEstadoDia(' + ${prod['idProducto']} + ', \'agotado\')'"
                                            class="adm-btn-text league-spartan">
                                            Agotar
                                        </button>

                                        <button th:if="${prod['estadoDia'] == 'agotado'}"
                                            th:onclick="'cambiarEstadoDia(' + ${prod['idProducto']} + ', \'disponible\')'"
                                            class="adm-btn-text league-spartan">
                                            Disponible
                                        </button>

                                        <button th:onclick="'eliminarProducto(' + ${prod['idProducto']} + ')'"
                                            class="adm-btn-text eliminar league-spartan">
                                            Eliminar
                                        </button>

                                    </td>

                                </tr>
                            </tbody>

                        </table>
                    </div>
                </div>

                <div class="panel-footer">
                    <!-- Bot√≥n Cerrar Carta -->
                    <button onclick="cerrarCarta()" class="adm-btn-close">
                        Cerrar Carta
                    </button>

                    <!-- Bot√≥n Abrir Carta -->
                    <button onclick="abrirCarta()" class="adm-btn-close" style="background: var(--color-third);">
                        Abrir Carta
                    </button>

                    <!-- Bot√≥n para abrir modal de agregar producto -->
                    <button class="adm-btn-close" style="background: var(--color-fourth);"
                        onclick="abrirModalAddProducto()">
                        Agregar Producto
                    </button>
                </div>

            </div>

        </div>
    </main>

    <!-- ====================== -->
    <!--   MODAL: LISTA         -->
    <!-- ====================== -->
    <div id="modalAgregarProducto" class="modal-carta">
        <div class="modal-contenido">

            <!-- Header -->
            <div class="modal-header">
                <h3>Agregar producto a la carta</h3>
                <button class="close-btn" onclick="cerrarModalAddProducto()">‚úñ</button>
            </div>

            <p class="subtitle">Selecciona un producto de la lista para agregarlo a la carta de hoy.</p>

            <!-- LISTA -->
            <div class="lista-productos-modal">

                <div class="item-modal" th:each="p : ${productosHistoricos}" th:data-id="${p['idProdHistoria']}"
                    th:data-precio="${p['precioUnitario']}" th:data-cantidad="${p['cantidadInicial']}"
                    onclick="seleccionarProducto(this)">

                    <div class="info">
                        <h4 th:text="${p['nomProducto']}"></h4>

                        <p>
                            <span class="tag">ID:</span>
                            <span th:text="${p['idProdHistoria']}"></span>
                        </p>

                        <p>
                            <span class="tag">Precio:</span>
                            S/ <span th:text="${p['precioUnitario']}"></span>
                        </p>

                        <p>
                            <span class="tag">Cant. Inicial:</span>
                            <span th:text="${p['cantidadInicial']}"></span>
                        </p>

                        <p>
                            <span class="tag">Vendidos:</span>
                            <span th:text="${p['vendidos']}"></span>
                        </p>

                        <p>
                            <span class="tag">Fecha:</span>
                            <span th:text="${p['fechaProducto']}"></span>
                        </p>
                    </div>

                    <div class="select-icon">
                        <i class="fas fa-check"></i>
                    </div>

                </div>


            </div>

            <!-- BOT√ìN AGREGAR -->
            <div class="modal-footer">
                <button class="btn-agregar-final" onclick="agregarSeleccionado()">Agregar a la carta</button>
            </div>

        </div>
    </div>

    <script>
        let datosSeleccionados = null;

        /* ============================
            ABRIR Y CERRAR MODAL
        =============================== */
        function abrirModalAddProducto() {
            document.getElementById("modalAgregarProducto").classList.add("active");
        }

        function cerrarModalAddProducto() {
            document.getElementById("modalAgregarProducto").classList.remove("active");
            datosSeleccionados = null;
        }

        /* ============================
            SELECCIONAR ITEM DEL MODAL
        =============================== */
        function seleccionarProducto(item) {

            // Quitar selecci√≥n previa
            document.querySelectorAll(".item-modal").forEach(x => x.classList.remove("selected"));

            // Marcar elemento
            item.classList.add("selected");

            // Guardar datos
            datosSeleccionados = {
                idProdHistoria: item.dataset.id,
                precio: item.dataset.precio,
                cantidad: item.dataset.cantidad
            };

            console.log("SELECCIONADO:", datosSeleccionados);
        }

        /* ============================
            ENVIAR AL BACKEND
        =============================== */
        function agregarSeleccionado() {

            if (!datosSeleccionados) {
                alert("Selecciona un producto antes de continuar.");
                return;
            }

            console.log("ENVIANDO AL BACKEND:", datosSeleccionados);

            fetch('/admin/carta/agregar', {
                method: 'POST',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(datosSeleccionados)
            })
                .then(async r => {
                    console.log("Respuesta HTTP:", r.status);

                    const data = await r.json().catch(() => null);
                    console.log("Body respuesta:", data);

                    if (r.ok && data && data.ok) {
                        location.reload();
                    } else {
                        alert(data?.mensaje || "Error al agregar el producto.");
                    }
                })
                .catch(err => {
                    console.error("ERROR FATAL EN FETCH:", err);
                    alert("No se pudo conectar con el servidor.");
                });
        }

        function guardarProducto(idProducto) {

            const precio = document.getElementById("precio_" + idProducto).value;
            const cantidad = document.getElementById("cantidad_" + idProducto).value;

            const datos = {
                idProducto: idProducto,
                precio: parseFloat(precio),
                cantidad: parseInt(cantidad)
            };

            console.log("Enviando datos para guardar:", datos);

            fetch('/admin/carta/guardar', {
                method: 'POST',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(datos)
            })
                .then(r => r.json())
                .then(data => {
                    console.log("RESPUESTA BACK:", data);

                    if (data.ok) {

                        // ================
                        // üîÑ ACTUALIZAR TABLA
                        // ================
                        actualizarFilaProducto(idProducto, precio, cantidad);

                    } else {
                        console.warn("Error:", data.mensaje);
                    }
                })
                .catch(err => {
                    console.error("ERROR en fetch:", err);
                });
        }

        function actualizarFilaProducto(idProducto, nuevoPrecio, nuevaCantidad) {

            // Actualizar inputs directamente
            document.getElementById("precio_" + idProducto).value = nuevoPrecio;
            document.getElementById("cantidad_" + idProducto).value = nuevaCantidad;

            // Toma el tr (fila)
            const fila = document.querySelector(`button[onclick="guardarProducto(${idProducto})"]`)
                .closest("tr");

            // Recalcular stock (si lo usas)
            const vendidos = parseInt(fila.children[4].innerText);
            const stock = nuevaCantidad - vendidos;

            fila.children[5].innerText = stock;

            // Animaci√≥n visual para indicar guardado
            fila.style.backgroundColor = "#d2f8d2"; // verde suave

            setTimeout(() => {
                fila.style.transition = "background-color 1s";
                fila.style.backgroundColor = "";
            }, 150);

            console.log("Fila actualizada visualmente.");
        }

        function cambiarVisible(idProducto, visible) {

            const datos = { idProducto, visible };

            console.log("CAMBIAR VISIBLE ENVIADO:", datos);

            fetch('/admin/carta/visible', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(datos)
            })
                .then(r => r.json())
                .then(data => {
                    console.log("RESPUESTA CAMBIAR VISIBLE:", data);

                    if (data.ok) location.reload();
                    else alert(data.mensaje);
                })
                .catch(err => console.error("ERROR cambiarVisible:", err));
        }

        function cambiarEstadoDia(idProducto, nuevoEstado) {

            const datos = { idProducto, estado: nuevoEstado };

            console.log("CAMBIAR ESTADO ENVIADO:", datos);

            fetch('/admin/carta/estado', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(datos)
            })
                .then(r => r.json())
                .then(data => {
                    console.log("RESPUESTA CAMBIAR ESTADO:", data);

                    if (data.ok) location.reload();
                    else alert(data.mensaje);
                })
                .catch(err => console.error("ERROR cambiarEstado:", err));
        }

        function eliminarProducto(idProducto) {

            if (!confirm("¬øSeguro que deseas eliminar este producto de la carta?")) return;

            const datos = { idProducto };

            console.log("ELIMINAR ENVIADO:", datos);

            fetch('/admin/carta/eliminar', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(datos)
            })
                .then(r => r.json())
                .then(data => {
                    console.log("RESPUESTA ELIMINAR:", data);

                    if (data.ok) location.reload();
                    else alert(data.mensaje);
                })
                .catch(err => console.error("ERROR eliminarProducto:", err));
        }

    </script>

</body>

</html>